metExploreD3.GraphNode={node:"",_MyThisGraphNode:"",panelParent:"",activePanel:"",taskClick:"",ctrlKey:"",groups:"",groupPath:"",groupFill:"",dblClickable:false,delayedInitialisation:function(a){metExploreD3.GraphNode.panelParent=a;_MyThisGraphNode=metExploreD3.GraphNode;activePanel=metExploreD3.GraphNode},dragstart:function(g,c){_MyThisGraphNode.activePanel=d3.event.sourceEvent.target.viewportElement.parentNode.id;if(_MyThisGraphNode.activePanel==""){_MyThisGraphNode.activePanel=d3.event.sourceEvent.target.parentNode.viewportElement.parentNode.id}d3.event.sourceEvent.stopPropagation();var f=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(f!=undefined){if(d3.event.sourceEvent.button==2){if(!g.isSelected()){_MyThisGraphNode.selection(g,_MyThisGraphNode.activePanel)}}else{_MyThisGraphNode.selection(g,_MyThisGraphNode.activePanel)}d3.selectAll("#D3viz").style("cursor","move");var e=f.getForce();e.stop();if(f.isLinked()){var h=_metExploreViz.getSessionsSet();for(var b in h){if(h[b].isLinked()&&_MyThisGraphNode.activePanel!=h[b].getId()){var a=h[b].getForce();a.stop()}}}}},refreshStyleOfReaction:function(){var a=metExploreD3.getReactionStyle();var b=d3.select("#viz").select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(c){return c.getBiologicalType()=="reaction"});b.select("text").remove();b.setNodeForm(a.getWidth(),a.getHeight(),a.getRX(),a.getRY(),a.getStrokeColor(),a.getStrokeWidth());b.each(function(c){metExploreD3.GraphNode.addText(c,"viz")})},refreshStyleOfMetabolite:function(){var b=metExploreD3.getMetaboliteStyle();var a=d3.select("#viz").select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(c){return c.getBiologicalType()=="metabolite"});a.select("text").remove();a.filter(function(c){return !c.getIsSideCompound()}).setNodeForm(b.getWidth(),b.getHeight(),b.getRX(),b.getRY(),undefined,b.getStrokeWidth());a.filter(function(c){return c.getIsSideCompound()}).setNodeForm(b.getWidth()/2,b.getHeight()/2,b.getRX()/2,b.getRY()/2,undefined,b.getStrokeWidth()/2);a.each(function(c){metExploreD3.GraphNode.addText(c,"viz")})},moveNode:function(b,a){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(c){if(_MyThisGraphNode.ctrlKey){return c.isSelected()}else{return b.getId()==c.getId()}}).each(function(c){c.px+=d3.event.dx;c.py+=d3.event.dy;c.x+=d3.event.dx;c.y+=d3.event.dy})},dragmove:function(g,c){if(!g.isSelected()){_MyThisGraphNode.selection(g,_MyThisGraphNode.activePanel)}_MyThisGraphNode.moveNode(g,_MyThisGraphNode.activePanel);_MyThisGraphNode.tick(_MyThisGraphNode.activePanel);var f=metExploreD3.getScaleById(_MyThisGraphNode.activePanel);metExploreD3.GraphLink.tick(_MyThisGraphNode.activePanel,f);var e=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(e.isLinked()){var h=_metExploreViz.getSessionsSet();for(var b in h){if(h[b].isLinked()&&_MyThisGraphNode.activePanel!=h[b].getId()){var a=metExploreD3.getScaleById(h[b].getId());_MyThisGraphNode.moveNode(g,h[b].getId());_MyThisGraphNode.tick(h[b].getId());metExploreD3.GraphLink.tick(h[b].getId(),a)}}}},dragend:function(h,e){var j=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);var c=_metExploreViz.getSessionById("viz");if(j!=undefined){if(j.isLinked()){var g=_metExploreViz.getSessionsSet();for(var l in g){if(g[l].isLinked()&&_MyThisGraphNode.activePanel!=g[l].getId()){var k=metExploreD3.GraphNetwork.isAnimated(c.getId());if(k=="true"){var f=c.getForce();if((metExploreD3.GraphNetwork.isAnimated(_MyThisGraphNode.panelParent)=="true")||(metExploreD3.GraphNetwork.isAnimated(_MyThisGraphNode.panelParent)==null)){f.resume()}}_MyThisGraphNode.tick(g[l].getId());var n=metExploreD3.getScaleById(g[l].getId());metExploreD3.GraphLink.tick(g[l].getId(),n)}}}else{var b=metExploreD3.GraphNetwork.isAnimated(_MyThisGraphNode.activePanel);if(b=="true"){var a=j.getForce();if((metExploreD3.GraphNetwork.isAnimated(_MyThisGraphNode.activePanel)=="true")||(metExploreD3.GraphNetwork.isAnimated(_MyThisGraphNode.activePanel)==null)){a.resume()}}_MyThisGraphNode.tick(_MyThisGraphNode.activePanel);var m=metExploreD3.getScaleById(_MyThisGraphNode.activePanel);metExploreD3.GraphLink.tick(_MyThisGraphNode.activePanel,m)}d3.selectAll("#D3viz").style("cursor","default")}},fixNodeOnRefresh:function(c,a){var b=_metExploreViz.getSessionById(a);if(b!=undefined){if(c.isSelected()){_MyThisGraphNode.selectNode(c,a)}else{_MyThisGraphNode.unSelectNode(c,a)}setTimeout(function(){if(b.isLinked()){var e=_metExploreViz.getSessionsSet();for(var d in e){if(e[d].isLinked()&&a!=e[d].getId()){d3.select("#"+e[d].getId()).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(f){return c.getId()==f.getId()}).each(function(f){f.setIsSelected(!f.isSelected())});if(c.isSelected()){_MyThisGraphNode.selectNode(c,e[d].getId())}else{_MyThisGraphNode.unSelectNode(c,e[d].getId())}}}}},200)}},selection:function(c,a){var b=_metExploreViz.getSessionById(a);if(b!=undefined){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return c.getId()==d.getId()}).each(function(d){d.setIsSelected(!d.isSelected())});if(c.isSelected()){_MyThisGraphNode.selectNode(c,a)}else{_MyThisGraphNode.unSelectNode(c,a)}setTimeout(function(){if(b.isLinked()){var e=_metExploreViz.getSessionsSet();for(var d in e){if(e[d].isLinked()&&a!=e[d].getId()){d3.select("#"+e[d].getId()).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(f){return c.getId()==f.getId()}).each(function(f){f.setIsSelected(!f.isSelected())});if(c.isSelected()){_MyThisGraphNode.selectNode(c,e[d].getId())}else{_MyThisGraphNode.unSelectNode(c,e[d].getId())}}}}},200)}},selectNode:function(h,b){var c=metExploreD3.getReactionStyle();var g=_metExploreViz.getSessionById(b);var f=metExploreD3.getMetabolitesSet();var a=metExploreD3.getReactionsSet();d3.select("#"+b).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return h.getId()==d.getId()}).each(function(d){d.fixed=true;g.addSelectedNode(d.getId());if(d.getBiologicalType()=="reaction"){d3.select(this).select("text").style("fill","white")}});var e=d3.select("#"+b).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return h.getId()==d.getId()}).select(".fontSelected").style("fill-opacity","0.4");_MyThisGraphNode.addText(h,b)},unSelectNode:function(f,b){var e=_metExploreViz.getSessionById(b);var c=metExploreD3.getMetabolitesSet();var a=metExploreD3.getReactionsSet();d3.select("#"+b).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return f.getId()==d.getId()}).select(".fontSelected").style("fill-opacity","0");d3.select("#"+b).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return f.getId()==d.getId()}).each(function(h){e.removeSelectedNode(h.getId());h.fixed=false;if(h.getBiologicalType()=="reaction"){var g;var d=metExploreD3.GraphUtils.chooseTextColor(this.style.getPropertyValue("fill"));d3.select(this).select("text").style("fill",d)}})},addText:function(e,a){var c=metExploreD3.getMetaboliteStyle();var b=metExploreD3.getReactionStyle();var g=_metExploreViz.getSessionById("viz");if(e.getBiologicalType()=="metabolite"){var f=Math.min(c.getWidth(),c.getHeight());if(d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).select("text")==""){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).each(function(n){var k=d3.select(this);var h=c.getDisplayLabel(n,c.getLabel());h=h.split(" ");k.text("");for(var j=0;j<h.length;j++){var l=$("<div/>").html(h[j]).text();var m=k.append("tspan").text(l);if(j>0){m.attr("x",0).attr("dy","5")}}}).style("font-size",c.getFontSize()).style("paint-order","stroke").style("stroke-width",1).style("stroke","white").style("stroke-opacity","0.7").attr("dy",".4em").style("font-weight","bold").style("pointer-events","none").attr("y",f/2+3)}if(e.getSvg()!="undefined"&&e.getSvg()!=undefined){if(d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).select("image").empty()){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).append("svg").attr("viewBox",function(h){return"0 0 "+f+" "+f}).attr("width",f*8/10+"px").attr("height",f*8/10+"px").attr("x",(-f/2)+(f*1/10)).attr("preserveAspectRatio","xMinYMin").attr("y",(-f/2)+(f*1/10)).attr("class","structure_metabolite").append("image").attr("xlink:href",function(h){return"resources/images/structure_metabolite/"+h.getSvg()}).attr("width","100%").attr("height","100%")}}}if(e.getLabelVisible()==true&&e.getBiologicalType()=="reaction"){if(d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).text()==""){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").filter(function(d){return e.getId()==d.getId()}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).text(function(i){var h=$("<div/>").html(b.getDisplayLabel(i,b.getLabel())).text();if(h==""){var h=$("<div/>").html(b.getDisplayLabel(i,b.getLabel())).text()}return h}).style("font-size",function(h){if(b.getDisplayLabel(h,b.getLabel())=="NA"){return 6}return Math.min(b.getWidth(),(b.getWidth()-b.getWidth()/10)/this.getComputedTextLength()*10)+"px"}).style("font-weight","bold").attr("dy",".3em")}}},addTextAllPanels:function(){var b=_metExploreViz.getSessionsSet();for(var a in b){d3.select("#"+b[a].getId()).select("#D3viz").select("#graphComponent").selectAll("g.node").each(function(c){metExploreD3.GraphNode.addText(c,b[a].getId())})}},removeText:function(a){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").select("text").remove()},removeTextAllPanels:function(a){var c=_metExploreViz.getSessionsSet();for(var b in c){metExploreD3.GraphNode.removeText(c[b].getId())}},searchNode:function(d){var a=d.toUpperCase();var b=d3.select("#viz").select("#D3viz").select("#graphComponent");var c=b.selectAll("g.node").filter(function(k,h){var g=false;if(k.getName()!=undefined){g=k.getName().toUpperCase().indexOf(a)>-1}var j=false;if(k.getEC()!=undefined){j=k.getEC().toUpperCase().indexOf(a)>-1}var f=false;if(k.getDbIdentifier()!=undefined){f=k.getDbIdentifier().toUpperCase().indexOf(a)>-1}var e=false;if(k.getCompartment()!=undefined){e=k.getCompartment().toUpperCase().indexOf(a)>-1}var l=false;if(k.getBiologicalType()!=undefined){l=k.getBiologicalType().toUpperCase().indexOf(a)>-1}return g||j||f||e||l});if(c.size()==0){metExploreD3.displayMessage("Warning",'The node "'+d+"\" doesn't exist.")}else{c.each(function(e){if(!e.isSelected()){_MyThisGraphNode.selection(e,"viz")}})}},refreshNode:function(m){d3.select("body").on("keydown",function(){_MyThisGraphNode.ctrlKey=d3.event.ctrlKey}).on("keyup",function(h){_MyThisGraphNode.ctrlKey=d3.event.ctrlKey});metExploreD3.GraphNode.panelParent=m;_MyThisGraphNode=metExploreD3.GraphNode;var b=d3.behavior.drag().on("dragstart",_MyThisGraphNode.dragstart).on("drag",_MyThisGraphNode.dragmove).on("dragend",_MyThisGraphNode.dragend);var e=metExploreD3.getReactionStyle();var i=metExploreD3.getMetaboliteStyle();var k=metExploreD3.getGeneralStyle();var j=_metExploreViz.getSessionById(m);var g=_metExploreViz.getSessionById("viz");var d=j.getD3Data();var f=parseInt(d3.select("#"+_MyThisGraphNode.panelParent).select("#D3viz").style("height"));var l=parseInt(d3.select("#"+_MyThisGraphNode.panelParent).select("#D3viz").style("width"));d3.selectAll("#D3viz").on("mouseup",this.unselectIfDBClick);var c=metExploreD3.getScaleById(m);metExploreD3.GraphNode.node=d3.select("#"+metExploreD3.GraphNode.panelParent).select("#D3viz").select("#graphComponent").selectAll("g.node").data(d.getNodes()).enter().append("svg:g").attr("class","node").call(b).style("fill","white").style("stroke-dasharray",function(h){if(h.getReactionReversibility()){return"2,2"}else{return""}});metExploreD3.GraphNode.node.filter(function(h){return !h.isDuplicated()}).on("mouseenter",function(o){var n=d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("g.node");d3.select(this).each(function(q){var p=n[0][n.size()-1];this.parentNode.insertBefore(this,p)}).attr("transform","translate("+o.x+", "+o.y+") scale(2)");var h=d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line.link");if(o.getBiologicalType()=="reaction"){h.filter(function(p){return o.getId()==p.getSource().getId()}).style("stroke","green").each(function(q){var p=h[0][h.size()-1];this.parentNode.insertBefore(this,p)});h.filter(function(p){return o.getId()==p.getTarget().getId()}).style("stroke","red").each(function(q){var p=h[0][h.size()-1];this.parentNode.insertBefore(this,p)})}else{h.filter(function(p){return o.getId()==p.getSource().getId()}).style("stroke","red").each(function(q){var p=h[0][h.size()-1];this.parentNode.insertBefore(this,p)});h.filter(function(p){return o.getId()==p.getTarget().getId()}).style("stroke","green").each(function(q){var p=h[0][h.size()-1];this.parentNode.insertBefore(this,p)})}}).on("mouseover",function(p){p.fixed=true;var o=c.getXScale();var n=c.getYScale();var h="Name: "+p.getName()+"<br/>Biological type: "+p.getBiologicalType()+((p.getCompartment()!=undefined)?"<br/>Compartment: "+p.getCompartment():"")+((p.getDbIdentifier()!=undefined)?"<br/>Database identifier: "+p.getDbIdentifier():"")+((p.getEC()!=undefined)?"<br/>EC number: "+p.getEC():"")+((p.getReactionReversibility()!=undefined)?"<br/>Reaction reversibility: "+p.getReactionReversibility():"")+((p.getIsSideCompound()!=undefined)?"<br/>SideCompound: "+p.getIsSideCompound():"")+((p.getMappingDatasLength()!=0)?((p.getMappingDatasLength()==1)?"<br/>Mapping:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>":"<br/>Mappings:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>"):"");p.getMappingDatas().forEach(function(q){h+="<tr><td>"+q.getMappingName()+"</td><td>"+q.getConditionName()+"</td><td>"+q.getMapValue()+"</td></tr>"});h+="</table>";if(p.getSvg()!=undefined&&p.getSvg()!="undefined"){h+='<br/><img src="resources/images/structure_metabolite/'+p.getSvg()+'"/>'}document.getElementById("tooltip2").innerHTML=h;document.getElementById("tooltip2").classList.remove("hide")}).on("mouseleave",function(n){d3.select(this).attr("transform","translate("+n.x+", "+n.y+") scale(1)");if(!n.isSelected()){n.fixed=false}var h=metExploreD3.getLinkStyle();document.getElementById("tooltip2").classList.add("hide");d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(o){return n.getId()==o.getSource().getId()||n.getId()==o.getTarget().getId()}).style("stroke",h.getStrokeColor());if(n.getBiologicalType()=="reaction"){d3.select(this).selectAll("rect").selectAll(".reaction, .fontSelected").transition().duration(750).attr("width",e.getWidth()).attr("height",e.getHeight()).attr("transform","translate(-"+e.getWidth()/2+",-"+e.getHeight()/2+")")}else{d3.select(this).selectAll("rect").selectAll(".metabolite, .fontSelected").transition().duration(750).attr("width",i.getWidth()).attr("height",i.getHeight()).attr("transform","translate(-"+i.getWidth()/2+",-"+i.getHeight()/2+")")}});metExploreD3.GraphNode.node.filter(function(h){return h.isDuplicated()}).on("mouseenter",function(n){var h=d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("g.node");d3.select(this).each(function(p){var o=h[0][h.size()-1];this.parentNode.insertBefore(this,o)}).attr("transform","translate("+n.x+", "+n.y+") scale(2)")}).on("mouseover",function(p){p.fixed=true;if(p.getBiologicalType()=="reaction"){d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(q){return p.getId()==q.getSource().getId()}).style("stroke","green");d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(q){return p.getId()==q.getTarget().getId()}).style("stroke","red")}else{d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(q){return p.getId()==q.getSource().getId()}).style("stroke","red");d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(q){return p.getId()==q.getTarget().getId()}).style("stroke","green")}var o=c.getXScale();var n=c.getYScale();var h="Name: "+p.getName()+"<br/>Biological type: "+p.getBiologicalType()+((p.getCompartment()!=undefined)?"<br/>Compartment: "+p.getCompartment():"")+((p.getDbIdentifier()!=undefined)?"<br/>Database identifier: "+p.getDbIdentifier():"")+((p.getEC()!=undefined)?"<br/>EC number: "+p.getEC():"")+((p.getReactionReversibility()!=undefined)?"<br/>Reaction reversibility: "+p.getReactionReversibility():"")+((p.getIsSideCompound()!=undefined)?"<br/>SideCompound: "+p.getIsSideCompound():"")+((p.getMappingDatasLength()!=0)?((p.getMappingDatasLength()==1)?"<br/>Mapping:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>":"<br/>Mappings:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>"):"");p.getMappingDatas().forEach(function(q){h+="<tr><td>"+q.getMappingName()+"</td><td>"+q.getConditionName()+"</td><td>"+q.getMapValue()+"</td></tr>"});h+="</table>";if(p.getSvg()!=undefined&&p.getSvg()!="undefined"){h+='<br/><img src="resources/images/structure_metabolite/'+p.getSvg()+'"/>'}document.getElementById("tooltip2").innerHTML=h;document.getElementById("tooltip2").classList.remove("hide")}).on("mouseleave",function(n){d3.select(this).attr("transform","translate("+n.x+", "+n.y+") scale(1)");if(!n.isSelected()){n.fixed=false}var h=metExploreD3.getLinkStyle();document.getElementById("tooltip2").classList.add("hide");d3.select("#"+m).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(o){return n.getId()==o.getSource().getId()||n.getId()==o.getTarget().getId()}).style("stroke",h.getStrokeColor());if(n.getBiologicalType()=="reaction"){d3.select(this).selectAll("rect").selectAll(".reaction, .fontSelected").transition().duration(750).attr("width",e.getWidth()).attr("height",e.getHeight()).attr("transform","translate(-"+e.getWidth()/2+",-"+e.getHeight()/2+")")}else{d3.select(this).selectAll("rect").selectAll(".reaction, .fontSelected").transition().duration(750).attr("width",i.getWidth()).attr("height",i.getHeight()).attr("transform","translate(-"+i.getWidth()/2+",-"+i.getHeight()/2+")")}});metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return !h.isDuplicated()}).addNodeForm(i.getWidth(),i.getHeight(),i.getRX(),i.getRY(),i.getStrokeColor(),i.getStrokeWidth());metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return h.isDuplicated()}).style("stroke-opacity",0.5).addNodeForm(i.getWidth()/2,i.getHeight()/2,i.getRX()/2,i.getRY()/2,i.getStrokeColor(),i.getStrokeWidth()/2);metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="reaction"}).addNodeForm(e.getWidth(),e.getHeight(),e.getRX(),e.getRY(),e.getStrokeColor(),e.getStrokeWidth());metExploreD3.sortCompartmentInBiosource();metExploreD3.GraphNode.colorStoreByCompartment(metExploreD3.GraphNode.node);if(d.getNodes().length<k.getReactionThreshold()||!k.isDisplayedLabelsForOpt()){var a=Math.min(i.getWidth(),i.getHeight());metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return h.getSvg()=="undefined"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).each(function(r){var o=d3.select(this);var h=i.getDisplayLabel(r,i.getLabel());h=h.split(" ");o.text("");for(var n=0;n<h.length;n++){var p=$("<div/>").html(h[n]).text();var q=o.append("tspan").text(p);if(n>0){q.attr("x",0).attr("dy","5")}}}).style("font-size",i.getFontSize()).style("paint-order","stroke").style("stroke-width",1).style("stroke","white").style("stroke-opacity","0.7").attr("dy",".4em").style("font-weight","bold").style("pointer-events","none").attr("y",a/2+3);metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return h.getSvg()!="undefined"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).each(function(r){var o=d3.select(this);var h=i.getDisplayLabel(r,i.getLabel());h=h.split(" ");o.text("");for(var n=0;n<h.length;n++){var p=$("<div/>").html(h[n]).text();var q=o.append("tspan").text(p);if(n>0){q.attr("x",0).attr("dy","7")}}}).style("font-size",i.getFontSize()).style("paint-order","stroke").style("stroke-width",1).style("stroke","white").style("stroke-opacity","0.7").attr("dy",".4em").style("font-weight","bold").style("pointer-events","none").attr("y",a/2+3);metExploreD3.GraphNode.node.filter(function(h){return(h.getBiologicalType()=="metabolite"&&h.getSvg()!="undefined"&&h.getSvg()!=undefined)}).append("svg").attr("viewBox",function(h){return"0 0 "+a+" "+a}).attr("width",a*8/10+"px").attr("height",a*8/10+"px").attr("x",(-a/2)+(a*1/10)).attr("preserveAspectRatio","xMinYMin").attr("y",(-a/2)+(a*1/10)).attr("class","structure_metabolite").append("image").attr("xlink:href",function(h){return"resources/images/structure_metabolite/"+h.getSvg()}).attr("width","100%").attr("height","100%");metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="reaction"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).text(function(n){var h=$("<div/>").html(e.getDisplayLabel(n,e.getLabel())).text();if(h==""){var h=$("<div/>").html(e.getDisplayLabel(n,e.getLabel())).text()}return h}).style("font-size",function(h){if(e.getDisplayLabel(h,e.getLabel())=="NA"){return 6}return Math.min(e.getWidth(),(e.getWidth()-e.getWidth()/10)/this.getComputedTextLength()*10)+"px"}).style("font-weight","bold").attr("dy",".3em")}metExploreD3.GraphNode.node.filter(function(h){return h.isSelected()}).each(function(h){_MyThisGraphNode.fixNodeOnRefresh(h,"viz")});metExploreD3.GraphNode.node.filter(function(h){return h.getMappingDatasLength()>0&&j.getActiveMapping()!=""}).filter(function(n){var h=n.getMappingDataByNameAndCond(j.getActiveMapping(),j.isMapped());return h!=null}).attr("mapped",function(r){var h=r.getMappingDataByNameAndCond(j.getActiveMapping(),j.isMapped());if(j.getMappingDataType()=="Continuous"){if(j.getColorMappingsSet()[0]<j.getColorMappingsSet()[1]){maxValue=j.getColorMappingsSet()[1];minValue=j.getColorMappingsSet()[0]}else{maxValue=j.getColorMappingsSet()[0];minValue=j.getColorMappingsSet()[1]}var o=_metExploreViz.getGeneralStyle();var s=o.getColorMinMappingContinuous();var q=o.getColorMaxMappingContinuous();var p=d3.scale.linear().domain([parseFloat(minValue),parseFloat(maxValue)]).range([s,q]);return p(parseFloat(h.getMapValue()))}var n=j.getColorMappingById(h.getMapValue()).getValue();return n}).style("fill",function(r){var h=r.getMappingDataByNameAndCond(j.getActiveMapping(),j.isMapped());d3.select(this).insert("rect",":first-child").attr("class","stroke").attr("width",parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("width"))+10).attr("height",parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("height"))+10).attr("rx",parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("rx"))+5).attr("ry",parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("ry"))+5).attr("transform","translate(-"+parseInt(parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("width"))+10)/2+",-"+parseInt(parseInt(d3.select(this).select("."+r.getBiologicalType()).attr("height"))+10)/2+")").style("opacity","0.5").style("fill","red");if(j.getMappingDataType()=="Continuous"){if(parseFloat(j.getColorMappingsSet()[0].getName())<parseFloat(j.getColorMappingsSet()[1].getName())){maxValue=parseFloat(j.getColorMappingsSet()[1].getName());minValue=parseFloat(j.getColorMappingsSet()[0].getName())}else{maxValue=parseFloat(j.getColorMappingsSet()[0].getName());minValue=parseFloat(j.getColorMappingsSet()[1].getName())}var o=_metExploreViz.getGeneralStyle();var s=o.getColorMinMappingContinuous();var q=o.getColorMaxMappingContinuous();var p=d3.scale.linear().domain([parseFloat(minValue),parseFloat(maxValue)]).range([s,q]);return p(parseFloat(h.getMapValue()))}var n=j.getColorMappingById(h.getMapValue()).getValue();return n})},tick:function(a){d3.select("#"+a).select("#D3viz").select("#graphComponent").selectAll("g.node").attr("cx",function(f){return f.x}).attr("cy",function(f){return f.y}).attr("transform",function(i){var h=1;if(d3.select(this)!=null){var g=d3.select(this).attr("transform");if(d3.select(this).attr("transform")!=null){var f=g.indexOf("scale(");if(f!=-1){h=parseInt(g.substring(f+6,g.length-1))}}}return"translate("+i.x+","+i.y+") scale("+h+")"});if(a=="viz"){var e=_metExploreViz.getSessionsSet();var c=_metExploreViz.getSessionById(a);if(c.isLinked()){for(var b in e){if(e[b].isLinked()&&a!=e[b].getId()&&d3.select("#"+e[b].getId()).select("#D3viz").select("#graphComponent")[0][0]!=null){d3.select("#"+e[b].getId()).select("#D3viz").select("#graphComponent").selectAll("g.node").each(function(f){d3.select("#viz").select("#D3viz").select("#graphComponent").selectAll("g.node").each(function(g){if(g.getId()==f.getId()){f.x=g.x;f.y=g.y}})});var d=metExploreD3.getScaleById(e[b].getId());metExploreD3.GraphLink.tick(e[b].getId(),d);_MyThisGraphNode.tick(e[b].getId())}}}}},selectNodeData:function(a){return d3.select(a).datum()},selectNodeFromGrid:function(a){d3.select("#viz").select("#D3viz").selectAll("g.node").filter(function(b){return b.getId()==a}).each(function(b){if(!b.isSelected()){_MyThisGraphNode.selection(b,"viz")}})},colorStoreByCompartment:function(b){for(var a=0;a<metExploreD3.getCompartmentInBiosourceLength();a++){b.filter(function(c){return(c.getBiologicalType()=="metabolite"&&c.getCompartment()==metExploreD3.getCompartmentInBiosourceSet()[a].getIdentifier())}).selectAll("rect").style("stroke",metExploreD3.getCompartmentInBiosourceSet()[a].getColor())}},unselectIfDBClick:function(){if(_MyThisGraphNode.dblClickable&&d3.event.button==0){_MyThisGraphNode.activePanel=this.parentNode.id;d3.select(this).select("#graphComponent").selectAll("g.node").filter(function(e){return e.isSelected()}).each(function(e){_MyThisGraphNode.selection(e,_MyThisGraphNode.activePanel)})}else{if(d3.event.button==0){_MyThisGraphNode.dblClickable=true;_MyThisGraphNode.taskClick=metExploreD3.createDelayedTask(function(){_MyThisGraphNode.dblClickable=false});metExploreD3.fixDelay(_MyThisGraphNode.taskClick,400)}}var c=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(c!=undefined){if(c.isLinked()){var d=_metExploreViz.getSessionById("viz");if(d!=undefined){var a=metExploreD3.GraphNetwork.isAnimated(d.getId());if(a=="true"){var b=d.getForce();if(b!=undefined){if(metExploreD3.GraphNetwork.isAnimated(d.getId())=="true"||metExploreD3.GraphNetwork.isAnimated(d.getId())==null){b.start()}}}}}else{var b=c.getForce();var a=metExploreD3.GraphNetwork.isAnimated(c.getId());if(a=="true"){var b=c.getForce();if(b!=undefined){if((metExploreD3.GraphNetwork.isAnimated(c.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(c.getId())==null)){b.start()}}}}}},loadNode:function(o){d3.select("body").on("keydown",function(){_MyThisGraphNode.ctrlKey=d3.event.ctrlKey}).on("keyup",function(h){_MyThisGraphNode.ctrlKey=d3.event.ctrlKey});metExploreD3.GraphNode.panelParent=o;_MyThisGraphNode=metExploreD3.GraphNode;var e=metExploreD3.getReactionStyle();var k=metExploreD3.getMetaboliteStyle();var m=metExploreD3.getGeneralStyle();var l=_metExploreViz.getSessionById(o);var j=_metExploreViz.getSessionById("viz");var d=l.getD3Data();var g=parseInt(d3.select("#"+_MyThisGraphNode.panelParent).select("#D3viz").style("height"));var n=parseInt(d3.select("#"+_MyThisGraphNode.panelParent).select("#D3viz").style("width"));d3.selectAll("#D3viz").on("mouseup",this.unselectIfDBClick);var c=metExploreD3.getScaleById(o);var b=d3.behavior.drag().on("dragstart",_MyThisGraphNode.dragstart).on("drag",_MyThisGraphNode.dragmove).on("dragend",_MyThisGraphNode.dragend);metExploreD3.GraphNode.node=d3.select("#"+metExploreD3.GraphNode.panelParent).select("#D3viz").select("#graphComponent").selectAll("g.node").data(d.getNodes()).enter().append("svg:g").attr("class","node").call(b).style("fill",function(h){if(h.isSelected()==false){return"white"}else{return"grey"}}).style("stroke-dasharray",function(h){if(h.getReactionReversibility()){return"2,2"}else{return""}}).on("mouseenter",function(p){var i=d3.select("#"+o).select("#D3viz").select("#graphComponent").selectAll("g.node");d3.select(this).each(function(r){var q=i[0][i.size()-1];this.parentNode.insertBefore(this,q)}).attr("transform","translate("+p.x+", "+p.y+") scale(2)");var h=d3.select("#"+o).select("#D3viz").select("#graphComponent").selectAll("line.link");if(p.getBiologicalType()=="reaction"){h.filter(function(q){return p.getId()==q.getSource().getId()}).style("stroke","green").each(function(r){var q=h[0][h.size()-1];this.parentNode.insertBefore(this,q)});h.filter(function(q){return p.getId()==q.getTarget().getId()}).style("stroke","red").each(function(r){var q=h[0][h.size()-1];this.parentNode.insertBefore(this,q)})}else{h.filter(function(q){return p.getId()==q.getSource().getId()}).style("stroke","red").each(function(r){var q=h[0][h.size()-1];this.parentNode.insertBefore(this,q)});h.filter(function(q){return p.getId()==q.getTarget().getId()}).style("stroke","green").each(function(r){var q=h[0][h.size()-1];this.parentNode.insertBefore(this,q)})}}).on("mouseover",function(q){q.fixed=true;var p=c.getXScale();var i=c.getYScale();var h="Name: "+q.getName()+"<br/>Biological type: "+q.getBiologicalType()+((q.getCompartment()!=undefined)?"<br/>Compartment: "+q.getCompartment():"")+((q.getDbIdentifier()!=undefined)?"<br/>Database identifier: "+q.getDbIdentifier():"")+((q.getEC()!=undefined)?"<br/>EC number: "+q.getEC():"")+((q.getReactionReversibility()!=undefined)?"<br/>Reaction reversibility: "+q.getReactionReversibility():"")+((q.getIsSideCompound()!=undefined)?"<br/>SideCompound: "+q.getIsSideCompound():"")+((q.getMappingDatasLength()!=0)?((q.getMappingDatasLength()==1)?"<br/>Mapping:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>":"<br/>Mappings:<br/><table style='width:100%; margin-left: 30px; padding-right: 30px;'>"):"");q.getMappingDatas().forEach(function(r){h+="<tr><td>"+r.getMappingName()+"</td><td>"+r.getConditionName()+"</td><td>"+r.getMapValue()+"</td></tr>"});h+="</table>";if(q.getSvg()!=undefined&&q.getSvg()!="undefined"){h+='<br/><img src="resources/images/structure_metabolite/'+q.getSvg()+'"/>'}document.getElementById("tooltip2").innerHTML=h;document.getElementById("tooltip2").classList.remove("hide")}).on("mouseleave",function(i){d3.select(this).attr("transform","translate("+i.x+", "+i.y+") scale(1)");if(!i.isSelected()){i.fixed=false}var h=metExploreD3.getLinkStyle();document.getElementById("tooltip2").classList.add("hide");d3.select("#"+o).select("#D3viz").select("#graphComponent").selectAll("line").filter(function(p){return i.getId()==p.getSource().getId()||i.getId()==p.getTarget().getId()}).style("stroke",h.getStrokeColor());if(i.getBiologicalType()=="reaction"){d3.select(this).selectAll("rect").selectAll(".reaction, .fontSelected").transition().duration(750).attr("width",e.getWidth()).attr("height",e.getHeight()).attr("transform","translate(-"+e.getWidth()/2+",-"+e.getHeight()/2+")")}else{d3.select(this).selectAll("rect").selectAll(".reaction, .fontSelected").transition().duration(750).attr("width",k.getWidth()).attr("height",k.getHeight()).attr("transform","translate(-"+k.getWidth()/2+",-"+k.getHeight()/2+")")}}).filter(function(h){return h.getMappingDatasLength()>0&&l.getActiveMapping()!=""}).attr("mapped",function(i){var h=i.getMappingDataByNameAndCond(l.getActiveMapping(),l.isMapped());return l.getColorMappingById(h.getMapValue())}).style("fill",function(i){var h=i.getMappingDataByNameAndCond(l.getActiveMapping(),l.isMapped());return l.getColorMappingById(h.getMapValue())});metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="metabolite"}).append("rect").attr("class",function(h){return h.getBiologicalType()}).attr("id",function(h){return h.getId()}).attr("identifier",function(h){return h.getId()}).attr("width",k.getWidth()).attr("height",k.getHeight()).attr("rx",k.getRX()).attr("ry",k.getRY()).attr("transform","translate(-"+k.getWidth()/2+",-"+k.getHeight()/2+")").style("stroke",k.getStrokeColor()).style("stroke-width",k.getStrokeWidth());metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="metabolite"}).append("rect").attr("class","fontSelected").attr("width",k.getWidth()).attr("height",k.getHeight()).attr("rx",k.getRX()).attr("ry",k.getRY()).attr("transform","translate(-"+k.getWidth()/2+",-"+k.getHeight()/2+")").style("fill-opacity","0").style("fill","#000");metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="reaction"}).append("rect").attr("class",function(h){return h.getBiologicalType()}).attr("id",function(h){return h.getId()}).attr("width",e.getWidth()).attr("height",e.getHeight()).attr("rx",e.getRX()).attr("ry",e.getRY()).attr("transform","translate(-"+e.getWidth()/2+",-"+e.getHeight()/2+")").style("stroke",e.getStrokeColor()).style("stroke-width",e.getStrokeWidth());metExploreD3.GraphNode.node.filter(function(h){return h.getBiologicalType()=="reaction"}).append("rect").attr("class","fontSelected").attr("width",e.getWidth()).attr("height",e.getHeight()).attr("rx",e.getRX()).attr("ry",e.getRY()).attr("transform","translate(-"+e.getWidth()/2+",-"+e.getHeight()/2+")").style("fill-opacity","0").style("fill","#000");metExploreD3.sortCompartmentInBiosource();for(var f=0;f<metExploreD3.getCompartmentInBiosourceLength();f++){metExploreD3.GraphNode.node.filter(function(h){return(h.getBiologicalType()=="metabolite"&&h.getCompartment()==metExploreD3.getCompartmentInBiosourceSet()[f].getIdentifier())}).selectAll("rect").style("stroke",metExploreD3.getCompartmentInBiosourceSet()[f].getColor())}if(d.getNodes().length<m.getReactionThreshold()||!m.isDisplayedLabelsForOpt()){var a=Math.min(k.getWidth(),k.getHeight());metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return h.getSvg()=="undefined"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).each(function(t){var q=d3.select(this);var h=k.getDisplayLabel(t,k.getLabel());h=h.split(" ");q.text("");for(var p=0;p<h.length;p++){var r=$("<div/>").html(h[p]).text();var s=q.append("tspan").text(r);if(p>0){s.attr("x",0).attr("dy","5")}}}).style("font-size",k.getFontSize()).style("paint-order","stroke").style("stroke-width",1).style("stroke","white").style("stroke-opacity","0.7").attr("dy",".4em").style("font-weight","bold").style("pointer-events","none").attr("y",a/2+3);metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="metabolite"}).filter(function(h){return h.getSvg()!="undefined"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).each(function(t){var q=d3.select(this);var h=k.getDisplayLabel(t,k.getLabel());h=h.split(" ");q.text("");for(var p=0;p<h.length;p++){var r=$("<div/>").html(h[p]).text();var s=q.append("tspan").text(r);if(p>0){s.attr("x",0).attr("dy","7")}}}).style("font-size",k.getFontSize()).style("paint-order","stroke").style("stroke-width",1).style("stroke","white").style("stroke-opacity","0.7").attr("dy",".4em").style("font-weight","bold").style("pointer-events","none").attr("y",a/2+3);metExploreD3.GraphNode.node.filter(function(h){return(h.getBiologicalType()=="metabolite"&&h.getSvg()!="undefined"&&h.getSvg()!=undefined)}).append("svg").attr("viewBox",function(h){return"0 0 "+a+" "+a}).attr("width",a*8/10+"px").attr("height",a*8/10+"px").attr("x",(-a/2)+(a*1/10)).attr("preserveAspectRatio","xMinYMin").attr("y",(-a/2)+(a*1/10)).attr("class","structure_metabolite").append("image").attr("xlink:href",function(h){return"resources/images/structure_metabolite/"+h.getSvg()}).attr("width","100%").attr("height","100%");metExploreD3.GraphNode.node.filter(function(h){return h.getLabelVisible()==true}).filter(function(h){return h.getBiologicalType()=="reaction"}).append("svg:text").attr("fill","black").attr("class",function(h){return h.getBiologicalType()}).text(function(i){var h=$("<div/>").html(e.getDisplayLabel(i,e.getLabel())).text();if(h==""){var h=$("<div/>").html(e.getDisplayLabel(i,e.getLabel())).text()}return h}).style("font-size",function(h){if(e.getDisplayLabel(h,e.getLabel())=="NA"){return 6}return Math.min(e.getWidth(),(e.getWidth()-e.getWidth()/10)/this.getComputedTextLength()*10)+"px"}).style("font-weight","bold").attr("dy",".3em")}metExploreD3.GraphNode.loadPath(metExploreD3.GraphNode.panelParent)},setIsSideCompoundById:function(h,f){var e=_metExploreViz.getSessionById("viz").getD3Data();var a=e.getNodes();if(a!=undefined){var d=e.getNodeById(h);if(d!=undefined){d.setIsSideCompound(f)}var g=_metExploreViz.getSessionsSet();for(var b in g){if(g[b].getId()!="viz"){var c=g[b].getD3Data().getNodeById(h);c.setIsSideCompound(f);if(c!=undefined){c.setIsSideCompound(f)}}}}},loadPath:function(c){var d=_metExploreViz.getSessionById(c);d3.select("#"+c).select("#D3viz").select("#graphComponent").selectAll("g.node");var b=metExploreD3.GraphNode.node.filter(function(e){return e.getBiologicalType()=="metabolite"});d.groups=d3.nest().key(function(e){return e.getCompartment()}).entries(b.data());metExploreD3.GraphNode.groupPath=function(k){var j=metExploreD3.getScaleById("viz");if(k.values.length>0){if(k.values.length>2){return"M"+d3.geom.hull(k.values.map(function(l){return[l.x,l.y]})).join("L")+"Z"}else{var h=[];k.values.forEach(function(i){h.push([i.x,i.y])});var f,e;for(var g=k.values.length;g<3;g++){f=k.values[0].x*(1+0.00001*g);e=k.values[0].y*(1+0.000011*g);h.push([f,e])}return"M"+d3.geom.hull(h).join("L")+"Z"}}};metExploreD3.GraphNode.groupFill=function(h,g){metExploreD3.sortCompartmentInBiosource();var e;for(var f=0;f<metExploreD3.getCompartmentInBiosourceLength();f++){if(h.key==metExploreD3.getCompartmentInBiosourceSet()[f].getIdentifier()){e=metExploreD3.getCompartmentInBiosourceSet()[f].getColor()}}return e};var a="M0,0L10,10Z";d3.select("#"+c).select("#D3viz").selectAll("path").filter(function(e){return e!="in"&&e!="out"}).data(d.groups).attr("d",function(e){return a}).enter().insert("path",":first-child").attr("class",function(e){return e.key}).attr("id",function(e){return e.key}).style("fill",metExploreD3.GraphNode.groupFill).style("stroke",metExploreD3.GraphNode.groupFill).style("stroke-width",40).style("stroke-linejoin","round").style("opacity",0.15)}};